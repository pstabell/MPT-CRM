<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MPT-CRM Card Scanner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 20px;
        }

        .camera-section {
            text-align: center;
            margin-bottom: 20px;
        }

        #camera {
            width: 100%;
            max-width: 100%;
            border-radius: 10px;
            display: none;
        }

        #preview {
            width: 100%;
            border-radius: 10px;
            display: none;
            margin-bottom: 15px;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .form-section {
            display: none;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }

        .checkbox-group label {
            margin: 0;
            color: #333;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
            font-size: 14px;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.processing {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        canvas {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“‡ Business Card Scanner</h1>
            <p>Snap, scan, and save in seconds</p>
        </div>

        <div class="content">
            <!-- Status Messages -->
            <div id="status" class="status"></div>
            <div id="spinner" class="spinner"></div>

            <!-- Camera Section -->
            <div id="camera-section" class="camera-section">
                <video id="camera" autoplay playsinline></video>
                <div id="card-images" style="display: none;">
                    <img id="preview" alt="Card front" style="margin-bottom: 10px;">
                    <img id="back-preview" alt="Card back" style="display: none;">
                </div>

                <input type="file" id="file-input" accept="image/*" capture="environment" style="display: none;">

                <button id="upload-photo" class="btn btn-primary">
                    ðŸ“¸ Take/Upload Photo
                </button>

                <button id="start-camera" class="btn btn-secondary" style="margin-top: 10px; font-size: 14px;">
                    Or use camera (requires HTTPS)
                </button>

                <button id="capture" class="btn btn-primary hidden">
                    âœ“ Capture Card
                </button>

                <button id="retake" class="btn btn-secondary hidden">
                    â†» Retake Photo
                </button>
            </div>

            <!-- Form Section -->
            <div id="form-section" class="form-section">
                <h3 style="margin-bottom: 15px; color: #333;">Review Contact Info</h3>

                <div class="form-group">
                    <label>Event Name (optional)</label>
                    <input type="text" id="event-name" placeholder="e.g., Tech Conference 2026">
                </div>

                <div class="form-group">
                    <label>First Name</label>
                    <input type="text" id="first-name" required>
                </div>

                <div class="form-group">
                    <label>Last Name</label>
                    <input type="text" id="last-name" required>
                </div>

                <div class="form-group">
                    <label>Company</label>
                    <input type="text" id="company">
                </div>

                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="title">
                </div>

                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email">
                </div>

                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="phone">
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="enroll" checked>
                    <label for="enroll">Enroll in 6-week networking campaign</label>
                </div>

                <button id="scan-back" class="btn btn-secondary" style="margin-bottom: 10px;">
                    ðŸ”„ Scan Back Side
                </button>

                <button id="import-btn" class="btn btn-primary">
                    ðŸ’¾ Import to CRM
                </button>

                <button id="scan-another" class="btn btn-secondary">
                    ðŸ“¸ Scan Another Card
                </button>
            </div>
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        const video = document.getElementById('camera');
        const canvas = document.getElementById('canvas');
        const preview = document.getElementById('preview');
        const fileInput = document.getElementById('file-input');
        const uploadPhotoBtn = document.getElementById('upload-photo');
        const startCameraBtn = document.getElementById('start-camera');
        const captureBtn = document.getElementById('capture');
        const retakeBtn = document.getElementById('retake');
        const importBtn = document.getElementById('import-btn');
        const scanBackBtn = document.getElementById('scan-back');
        const scanAnotherBtn = document.getElementById('scan-another');
        const status = document.getElementById('status');
        const spinner = document.getElementById('spinner');
        const cameraSection = document.getElementById('camera-section');
        const formSection = document.getElementById('form-section');

        let stream = null;
        let capturedImage = null;
        let backSideImage = null;

        // Upload/Take photo (works on all phones!)
        uploadPhotoBtn.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                showStatus('Compressing image...', 'processing');

                const reader = new FileReader();
                reader.onload = (event) => {
                    // Compress large images
                    const img = new Image();
                    img.onload = () => {
                        // Resize if too large (max 1600px)
                        let width = img.width;
                        let height = img.height;
                        const maxSize = 1600;

                        if (width > maxSize || height > maxSize) {
                            if (width > height) {
                                height = (height / width) * maxSize;
                                width = maxSize;
                            } else {
                                width = (width / height) * maxSize;
                                height = maxSize;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        canvas.getContext('2d').drawImage(img, 0, 0, width, height);

                        const imageData = canvas.toDataURL('image/jpeg', 0.85);

                        // Check if scanning back side
                        if (backSideImage) {
                            // This is the back side
                            const backPreview = document.getElementById('back-preview');
                            backPreview.src = imageData;
                            backPreview.style.display = 'block';
                            showStatus('âœ“ Both sides scanned! Review contact info below.', 'success');
                            backSideImage = imageData; // Store the actual back image
                        } else {
                            // This is the front side
                            capturedImage = imageData;
                            preview.src = capturedImage;
                            document.getElementById('card-images').style.display = 'block';
                            uploadPhotoBtn.classList.add('hidden');
                            startCameraBtn.classList.add('hidden');
                            retakeBtn.classList.remove('hidden');
                            processImage();
                        }
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Start camera
        startCameraBtn.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                video.srcObject = stream;
                video.style.display = 'block';
                uploadPhotoBtn.classList.add('hidden');
                startCameraBtn.classList.add('hidden');
                captureBtn.classList.remove('hidden');
            } catch (err) {
                showStatus('Camera access denied. Try "Take/Upload Photo" button instead.', 'error');
            }
        });

        // Capture photo
        captureBtn.addEventListener('click', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            capturedImage = canvas.toDataURL('image/jpeg', 0.8);
            preview.src = capturedImage;

            video.style.display = 'none';
            preview.style.display = 'block';
            captureBtn.classList.add('hidden');
            retakeBtn.classList.remove('hidden');

            // Stop camera
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            // Process image
            processImage();
        });

        // Retake photo
        retakeBtn.addEventListener('click', () => {
            preview.style.display = 'none';
            retakeBtn.classList.add('hidden');
            startCameraBtn.classList.remove('hidden');
            formSection.style.display = 'none';
            capturedImage = null;
        });

        // Process image - just show form (manual entry is faster than OCR)
        async function processImage() {
            showStatus('âœ“ Card saved! Type contact info below while looking at the photo.', 'success');
            formSection.style.display = 'block';

            // Focus on first name field
            setTimeout(() => {
                document.getElementById('first-name').focus();
            }, 100);
        }

        // Populate form with extracted data
        function populateForm(contact) {
            document.getElementById('first-name').value = contact.first_name || '';
            document.getElementById('last-name').value = contact.last_name || '';
            document.getElementById('company').value = contact.company || '';
            document.getElementById('title').value = contact.title || '';
            document.getElementById('email').value = contact.email || '';
            document.getElementById('phone').value = contact.phone || '';
        }

        // Scan back side
        scanBackBtn.addEventListener('click', () => {
            showStatus('ðŸ“¸ Tap to scan back side of card...', 'processing');
            backSideImage = capturedImage; // Save front side
            fileInput.click(); // Open camera again for back side
        });

        // Import contact
        importBtn.addEventListener('click', async () => {
            showStatus('ðŸ’¾ Importing contact...', 'processing');
            spinner.style.display = 'block';
            importBtn.disabled = true;

            const contactData = {
                first_name: document.getElementById('first-name').value,
                last_name: document.getElementById('last-name').value,
                company: document.getElementById('company').value,
                title: document.getElementById('title').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                source_detail: document.getElementById('event-name').value
            };

            try {
                const response = await fetch('/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contact: contactData,
                        enroll: document.getElementById('enroll').checked,
                        event_name: document.getElementById('event-name').value,
                        front_image: capturedImage,
                        back_image: backSideImage
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const name = document.getElementById('first-name').value + ' ' + document.getElementById('last-name').value;
                    const action = result.updated ? 'ðŸ”„ Updated' : 'âœ… Created';
                    const enrollMsg = result.enrolled && !result.updated ? 'ðŸ“§ Enrolled in campaign.' : '';
                    showStatus(`${action}: ${name.trim()}! ${enrollMsg} Ready for next card...`, 'success');
                    setTimeout(() => {
                        resetForm();
                    }, 3000);
                } else {
                    showStatus('Error: ' + result.error, 'error');
                    importBtn.disabled = false;
                }
            } catch (err) {
                showStatus('Import failed: ' + err.message, 'error');
                importBtn.disabled = false;
            } finally {
                spinner.style.display = 'none';
            }
        });

        // Scan another card
        scanAnotherBtn.addEventListener('click', resetForm);

        function resetForm() {
            formSection.style.display = 'none';
            document.getElementById('card-images').style.display = 'none';
            preview.style.display = 'none';
            document.getElementById('back-preview').style.display = 'none';
            retakeBtn.classList.add('hidden');
            uploadPhotoBtn.classList.remove('hidden');
            startCameraBtn.classList.remove('hidden');
            status.style.display = 'none';
            importBtn.disabled = false;
            fileInput.value = '';
            document.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"]').forEach(input => input.value = '');
            capturedImage = null;
            backSideImage = null;
        }

        function showStatus(message, type) {
            status.textContent = message;
            status.className = 'status ' + type;
            status.style.display = 'block';
        }
    </script>
</body>
</html>
